#!/bin/bash
# proxychan ‚Äî A tool by socalit to run commands anonymously through proxychains + Tor with automatic IP rotation

CHAIN_BIN=$(command -v proxychains4 || command -v proxychains)
TOR_BIN=$(command -v tor)
TORRC_FILE="/etc/tor/torrc"
CONF_FILE="/etc/proxychains4.conf"
BIN_PATH="/usr/local/bin/proxychan"

# --install logic
if [[ "$1" == "--install" ]]; then
  echo "üì¶ Installing proxychan system-wide (by socalit)..."
  if [[ ! -f "$0" ]]; then
    echo "[‚úñ] Script not found. Please run this command from the script directory."
    exit 1
  fi
  sudo cp "$0" "$BIN_PATH"
  sudo chmod +x "$BIN_PATH"
  echo "[‚úì] Installed to $BIN_PATH"
  echo "‚úÖ You can now run: proxychan curl https://ifconfig.me"
  exit 0
fi

install_tor_if_needed() {
  if [[ -z "$TOR_BIN" ]]; then
    echo "[!] Tor not found. Installing..."
    sudo apt update
    sudo apt install tor -y
    TOR_BIN=$(command -v tor)
  fi
}

patch_torrc() {
  local updated=0
  if ! grep -q "^ControlPort 9051" "$TORRC_FILE"; then
    echo "ControlPort 9051" | sudo tee -a "$TORRC_FILE" > /dev/null
    updated=1
  fi
  if ! grep -q "^CookieAuthentication" "$TORRC_FILE"; then
    echo "CookieAuthentication 0" | sudo tee -a "$TORRC_FILE" > /dev/null
    updated=1
  fi
  if ! grep -q "^SOCKSPort 9050" "$TORRC_FILE"; then
    echo "SOCKSPort 9050" | sudo tee -a "$TORRC_FILE" > /dev/null
    updated=1
  fi
  if [[ $updated -eq 1 ]]; then
    echo "[‚úì] torrc updated. Restarting Tor..."
    sudo systemctl restart tor || sudo service tor restart
    sleep 5
  fi
}

start_tor() {
  if ! pgrep tor > /dev/null; then
    echo "[!] Starting Tor service..."
    sudo systemctl start tor || sudo service tor start
    sleep 5
  fi
  if ! pgrep tor > /dev/null; then
    echo "[‚úñ] Tor failed to start. Check logs with: journalctl -xeu tor"
    exit 1
  fi
}

check_tor_port() {
  if ! ss -tuln | grep -q ":9050"; then
    echo "[‚úñ] Tor is not listening on 127.0.0.1:9050"
    echo "    Try restarting: sudo systemctl restart tor"
    exit 1
  fi
}

rotate_tor_ip() {
  echo "[‚Üª] Requesting new Tor circuit..."
  echo -e 'AUTHENTICATE ""\nSIGNAL NEWNYM\nQUIT' | nc 127.0.0.1 9051 > /dev/null 2>&1
  if [[ $? -ne 0 ]]; then
    echo "[!] Could not rotate IP ‚Äî ControlPort may not be active."
  else
    echo "[‚úì] New Tor IP requested."
    sleep 3
  fi
}

test_proxy() {
  echo "[‚úì] Verifying Tor proxy routing..."
  $CHAIN_BIN curl -s --max-time 10 https://check.torproject.org | grep -q "Congratulations"
  if [[ $? -eq 0 ]]; then
    echo "[‚úì] Proxychains is routing through Tor."
  else
    echo "[!] Proxychains is NOT routing through Tor. Check $CONF_FILE"
    exit 1
  fi
}

if [[ ! -x "$CHAIN_BIN" ]]; then
  echo "[‚úñ] proxychains not found. Installing..."
  sudo apt update
  sudo apt install proxychains4 -y
  CHAIN_BIN=$(command -v proxychains4 || command -v proxychains)
fi

if [[ $# -lt 1 ]]; then
  echo "Usage:"
  echo "  proxychan <command>       Run command anonymously through Tor"
  echo "  proxychan --install       Install system-wide to /usr/local/bin"
  exit 1
fi

install_tor_if_needed
patch_torrc
start_tor
check_tor_port
rotate_tor_ip
test_proxy

# Show Real IP
real_ip=$(curl -s https://ifconfig.me || echo "Unavailable")

# Show Tor IP via proxychains
tor_ip=$($CHAIN_BIN curl -s --max-time 10 https://ifconfig.me 2>/dev/null || echo "Unavailable")

# Display IPs
echo
echo "üåê Checking public IPs..."
echo "üîç Real IP: $real_ip"
echo "üï≥Ô∏è Tor IP:  $tor_ip"
echo

echo "üöÄ Running: $CHAIN_BIN $*"
exec $CHAIN_BIN "$@"
