#!/bin/bash
# proxychan â€” A tool by socalit to run commands anonymously through proxychains + Tor with automatic IP rotation

CHAIN_BIN=$(command -v proxychains4 || command -v proxychains)
TOR_BIN=$(command -v tor)
TORRC_FILE="/etc/tor/torrc"
CONF_FILE="/etc/proxychains4.conf"
BIN_PATH="/usr/local/bin/proxychan"

# --install logic
if [[ "$1" == "--install" ]]; then
  echo "ğŸ“¦ Installing proxychan system-wide (by socalit)..."
  if [[ ! -f "$0" ]]; then
    echo "[âœ–] Script not found. Please run this command from the script directory."
    exit 1
  fi
  sudo cp "$0" "$BIN_PATH"
  sudo chmod +x "$BIN_PATH"
  echo "[âœ“] Installed to $BIN_PATH"
  echo "âœ… You can now run: proxychan curl https://icanhazip.com"
  exit 0
fi

install_tor_if_needed() {
  if [[ -z "$TOR_BIN" ]]; then
    echo "[!] Tor not found. Installing..."
    sudo apt update
    sudo apt install tor -y
    TOR_BIN=$(command -v tor)
  fi
}

patch_torrc() {
  local updated=0
  if ! grep -q "^ControlPort 9051" "$TORRC_FILE"; then
    echo "ControlPort 9051" | sudo tee -a "$TORRC_FILE" > /dev/null
    updated=1
  fi
  if ! grep -q "^CookieAuthentication" "$TORRC_FILE"; then
    echo "CookieAuthentication 0" | sudo tee -a "$TORRC_FILE" > /dev/null
    updated=1
  fi
  if ! grep -q "^SOCKSPort 9050" "$TORRC_FILE"; then
    echo "SOCKSPort 9050" | sudo tee -a "$TORRC_FILE" > /dev/null
    updated=1
  fi
  if [[ $updated -eq 1 ]]; then
    echo "[âœ“] torrc updated. Restarting Tor..."
    sudo systemctl restart tor || sudo service tor restart
    sleep 5
  fi
}

start_tor() {
  if ! pgrep tor > /dev/null; then
    echo "[!] Starting Tor service..."
    sudo systemctl start tor || sudo service tor start
    sleep 5
  fi
  if ! pgrep tor > /dev/null; then
    echo "[âœ–] Tor failed to start. Check logs with: journalctl -xeu tor"
    exit 1
  fi
}

check_tor_port() {
  if ! ss -tuln | grep -q ":9050"; then
    echo "[âœ–] Tor is not listening on 127.0.0.1:9050"
    echo "    Try restarting: sudo systemctl restart tor"
    exit 1
  fi
}

rotate_tor_ip() {
  echo "[â†»] Requesting new Tor circuit..."
  echo -e 'AUTHENTICATE ""\nSIGNAL NEWNYM\nQUIT' | nc 127.0.0.1 9051 > /dev/null 2>&1
  if [[ $? -ne 0 ]]; then
    echo "[!] Could not rotate IP â€” ControlPort may not be active."
  else
    echo "[âœ“] New Tor IP requested."
    sleep 3
  fi
}

test_proxy() {
  echo "[âœ“] Verifying Tor proxy routing..."
  local result=$($CHAIN_BIN curl -s --max-time 10 https://check.torproject.org/api/ip 2>/dev/null)
  echo "$result" | grep -q '"IsTor":true'
  if [[ $? -eq 0 ]]; then
    echo "[âœ“] Proxychains is routing through Tor."
  else
    echo "[!] Proxychains is NOT routing through Tor. Check $CONF_FILE"
    exit 1
  fi
}

if [[ ! -x "$CHAIN_BIN" ]]; then
  echo "[âœ–] proxychains not found. Installing..."
  sudo apt update
  sudo apt install proxychains4 -y
  CHAIN_BIN=$(command -v proxychains4 || command -v proxychains)
fi

if [[ $# -lt 1 ]]; then
  echo "Usage:"
  echo "  proxychan <command>       Run command anonymously through Tor"
  echo "  proxychan --install       Install system-wide to /usr/local/bin"
  exit 1
fi

install_tor_if_needed
patch_torrc
start_tor
check_tor_port
rotate_tor_ip
test_proxy

# Show Real IP
real_ip=$(curl -s https://icanhazip.com || echo "Unavailable")

# Show Tor IP via proxychains
tor_ip=$($CHAIN_BIN curl -s --max-time 10 https://icanhazip.com 2>/dev/null || echo "Unavailable")

# Display IPs and validate
echo
echo "ğŸŒ Checking public IPs..."
echo "ğŸ” Real IP: $real_ip"
echo "ğŸ•³ï¸ Tor IP:  $tor_ip"

if [[ "$tor_ip" == "$real_ip" || "$tor_ip" == "Unavailable" ]]; then
  echo "[âœ–] Proxychains failed â€” you're leaking your real IP!"
  exit 1
fi

echo
echo "ğŸš€ Running: $CHAIN_BIN $*"
exec $CHAIN_BIN "$@"
